
\subsection{Programación variador de velocidad}


Para realizar la configuración del variador de velocidad con los parámetros del motor se utilizó el software \textbf{SoMove} a través del protocolo \textbf{ModBus}. Se descargó la ultima versión desde la página oficial de \textbf{Schneider Electric}\footnote{\url{https://www.se.com/ar/es/product-range-presentation/2714-somove/}} y luego, la librería DTM correspondiente al variador a utilizado \footnote{\url{https://www.se.com/ar/es/download/document/Altivar_DTM_Library/}}.

Una vez realizado esto se procedió a generar un nuevo proyecto donde se eligió las características del variador (Figura \ref{fig:so1} y \ref{fig:so2}). El próximo paso fue realizar por medio del software la carga de los parámetros del motor (Figura \ref{fig:paramsomove}) y establecer el modo de funcionamiento de las entradas y el protocolo de comunicación.
\begin{figure}[h]
	\centering
	\includegraphics[width=0.9\linewidth]{somove1.png}
	\captionof{figure}{Elección de Altivar 312}
	\label{fig:so1}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\linewidth]{somove2.png}
	\captionof{figure}{Parámetros del variador}
	\label{fig:so2}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\linewidth]{images/paramsomove}
	\captionof{figure}{Lista de parámetros modificados}
	\label{fig:paramsomove}
\end{figure}


Para realizar esta primera configuración se realizó la comunicación de la computadora con el variador a través del protocolo \textbf{ModBus} (Figura\ref{fig:pcvar}) por medio de un cable que en un extremo poseía una ficha RJ45 con un conversor RS485 y en el otro, ficha USB (Figura \ref{fig:paramsomove1}). 
\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\linewidth]{pc_var.png}
	\captionof{figure}{Diegrama comunicación PC- Variador}
	\label{fig:pcvar}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\linewidth]{paramsomove1.png}
	\captionof{figure}{Cable de comunicación}
	\label{fig:paramsomove1}
\end{figure}


\subsection{Comunicación variador de velocidad - PLC}
Para poder realizar la comunicación entre el variador y el PLC es necesario contar con un cable que realice la conexión desde la salida \textbf{CANOpen} a RS485, para esto se necesitó hacer un cable con las fichas correspondientes en cada extremo según las conexiones que muestran en la Figura \ref{fig:cable}, colocando a su vez resistencia de 120 $\Omega$ en cada punta para evitar ruidos eléctricos y fenómenos de reflexión en la línea.

\begin{figure}[htbp]
    \centering
    \subfigure[Ficha entrada/salida variador]{\includegraphics[width=60mm]{canconectores.png}}
    \subfigure[Ficha entrada/salida PLC]{\includegraphics[width=80mm]{candb9.png}}
    \caption{Conexión fichas RJ45- DB9} \label{fig:cable}
    \end{figure}



\subsection{Programación Unity Pro}


Para generar la base del proyecto para trabajar, se debe descargar desde la página oficial e instalar el software \textbf{Unity Pro XL} y la librería DTM utilizada en el software \textbf{soMove} correspondiente al variador que se posee. Una vez que esto está instalado se abre un nuevo proyecto y se configura siguiendo los siguientes pasos.
\begin{enumerate}
	\item Se selecciona el bastidor que se posee.
	\item En la configuración gráfica del bastidor (Figura \ref{fig:uni0})
	podemos introducir los módulos
	deseados haciendo un clic en la
	posición seleccionada (Figura \ref{fig:uni1}).
	El laboratorio cuenta con un PLC modular didáctico de la marca \textbf{Schneider Electric} de la familia \textbf{Modicon} modelo \textbf{M340} con los módulos nombrados anteriormente (Sección \ref{sec:didac}). 
	\item Se debe configurar el módulo Ethernet desde el explorador de
	Proyectos desplegamos la
	carpeta Comunicación y se realiza clic con el botón derecho sobre Redes y luego en Nueva Red, Ethernet (Figura  \ref{fig:inter}).
	\item Se creó una nueva sección para lenguaje FDB para ver parámetros básicos.
	\begin{itemize}
		\item Los Diagramas de Bloques de Función consisten en un Editor gráfico orientado al dibujo
		de bloques. El lenguaje consiste en los Bloques de Funciones reusables elementales y
		derivados.
	\end{itemize}
%\item Para realizar la conexión del PLC con la computadora se utiliza protocolo TCP/IP a través de la dirección 192.168.10.187 (Dirección que el PLC tiene configurada internamente)(Figura \ref{fig:direcc}) y (Figura \ref{fig:inter})
\end{enumerate}
	
	\begin{comment}
	que posee los siguientes módulos:
\begin{itemize}
\item BMX XBP 0400: bastidor para 4 módulos más la fuente de alimentación.
\item BMX P34 2030: CPU 340-20 Ethernet CANopen.   (Comunicación)
\item BMX ART 0414: 4 entradas TC/RTD con separación de potencial.
\item BMX DDM 16022: 8 entradas digitales, y 8 salidas digitales por transistor PNP, todas ellas aisladas.
\item BMX CPS 2000: Fuente de alimentación de 220V
\end{itemize}

	\end{comment}


\begin{center}
	\includegraphics[width=0.9\linewidth]{unit1.png}
	\captionof{figure}{Elección del bastidor}
	\label{fig:uni1}
	\includegraphics[width=0.9\linewidth]{unity1.png}
	\captionof{figure}{Módulos PLC}
	\label{fig:uni0}
\end{center}

\begin{figure}[h]
	\centering
	\includegraphics[scale=1]{1.direcc.png}
	\captionof{figure}{Dirección IP}
	\label{fig:direcc}
\end{figure}


\begin{figure}[h]
	\centering
	\includegraphics[width=0.9\linewidth]{2.ethern.png}
	\captionof{figure}{Dirección módulo Ethernet}
	\label{fig:inter}
\end{figure}

Una vez que se completó la configuración de la comunicación variador - PLC se procedió a crear una \textit{Pantalla de operador} dentro del mismo programa (Figura \ref{fig:previo})
la cual fue utilizada para interactuar y observar diversos parámetros, como modificar velocidades, observar señales luminosas y ver distintos valores proporcionados por el variador de velocidad.
 
\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\linewidth]{3.previo.png}
	\captionof{figure}{HMI simple}
	\label{fig:previo}
\end{figure}

Para realizar la programación del HMI se utilizó los MFB del software UnityPro (Figura \ref{fig:read}). Estos bloques necesitan de un bloque maestro ``CAN\_HANDLER'' el cual permite comprobar la comunicación \textbf{CANopen}, así como la coherencia
entre las configuraciones de software y física.
\\
Otros de los bloques más utilizados dentro del programa fueron ``MC\_READPARAMETER'' que se utiliza para leer, mediante mensajes SDO, una variable del variador definida en una dirección \textbf{CANOpen} dada por el fabricante \cite{ComManual}.

\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\linewidth]{4.read.png}
	\captionof{figure}{Programa con bloques MFB}
	\label{fig:read}
\end{figure}



\subsubsection{Entradas analógicas}
En el rack del PLC se encuentra un módulo AMI0410 el cual consiste en cuatro entradas analógicas (Tensión/Corriente) aisladas del siguiente tipo:
\begin{itemize}
	\item Corriente +/- 20 mA
\item 	Corriente 0 a 20 mA
\item 	Corriente 4 a 20 mA
\item 	Tensión +/- 10 V
\item 	Tensión +/- 5 V
\item 	Tensión 0 a 10 V
\item 	Tensión 0 a 5 V
\item 	Tensión 1 a 5 V
	
\end{itemize}

El módulo dispone de 20 bornes accesibles al usuario siendo el diagrama de conexión tanto para entradas de tensión o corriente el mostrado en la figura \ref{fig:modulo}.

Para la configuración en \textbf{Unity PRO} se eligen de las opciones anteriores la que se va a utilizar, en nuestro caso de 4 a 20 mA y el escalado predefinido de fábrica es de 0 a 10000 cuentas pero modificable por el usuario entre -32768 a 32767 ya que la resolución de las entradas analógicas es de 16 bit. También es posible añadir un filtro de primer orden a cada entrada por software (Figura \ref{fig:param}).

Con el rango de cuentas del módulo determinado, se requiere escalar la variable para obtener el valor físico y así utilizarla para la visualización y control del banco de pruebas.
Para el escalado de la señal de entrada se realizó un nuevo bloque FB derivado, que fue construido en base a elementos primarios, para evitar realizar un proceso repetitivo para el escalado de varias señales (Figura \ref{fig:escalado}).

En la variable de entrada se coloca la señal que se desea escalar. En los límites de entrada se escribe el rango del módulo visto anteriormente, y en los límites de salida, los escalados obtenidos del instrumento utilizado. A la salida del bloque se obtiene el valor físico visualizado o transmitido por el instrumento.

\begin{figure}[H]
	\centering
	\includegraphics[width=0.6\linewidth]{modulo.png}
	\captionof{figure}{Módulo AMI0410}
	\label{fig:modulo}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\linewidth]{param.png}
	\captionof{figure}{Rango y escalado}
	\label{fig:param}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\linewidth]{escalado.png}
	\captionof{figure}{Bloques de escalado}
	\label{fig:escalado}
\end{figure}


\subsubsection{Entradas analogicas para termocuplas o RTD}
Se utiliza el módulo ART0414 que consiste en cuatro entradas aisladas en las que se pueden conectar sensores de temperatura del tipo termocupla y RTD con las siguientes características:
\begin{itemize}
	\item RTD IEC Pt100/Pt1000, US/JIS Pt100/Pt1000, Cu10, Cu50, Cu100, Ni100/Ni1000 en 2, 3 o 4 conductores
	\item Termoelemento del tipo B, E, J, K, L, N, R, S, T, U
\item 	Tensión $+/-$ 40 mV a 1,28 V
	
\end{itemize}

Para la conexión de sensores se utiliza el accesorio TELEFAST ABE-7CPA412 (Figura \ref{fig:ABE}). Y se tienen las siguientes formas de conexión dependiendo el tipo de sensor (Figura \ref{fig:ABE2}).

\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\linewidth]{ABE.png}
	\captionof{figure}{Accesorio TELEFAST ABE-7CPA412}
	\label{fig:ABE}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\linewidth]{ABE2.png}
	\captionof{figure}{Conexión según sensor}
	\label{fig:ABE2}
\end{figure}

Para su configuración en Unity Pro se selecciona en Rango las características del sensor y en escala se modifica los valores para que coincidan con los máximos y mínimos del sensor. Para el caso de RTD y Termocupla los valores son múltiplos de 10 respecto a la temperatura en °C o °F. 
En la imagen \ref{fig:ABE3} se observan dos elementos ya que se probó realizar la configuración con una termocupla y un RTD. Finalmente se eligió el RTD PT1000 dónde el valor obtenido se divide por 10 y se genera el valor de temperatura en °C con un decimal  (Figura \ref{fig:ABE3}).

\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\linewidth]{ABE3.png}
	\captionof{figure}{Rango y escalado}
	\label{fig:ABE3}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.6\linewidth]{ABE4.png}
	\captionof{figure}{Bloque de escalado}
	\label{fig:ABE4}
\end{figure}

\subsubsection{Medición de caudal}
Según la cantidad de flujo que pase por el caudalímetro, este entregaría pulsos que debían ser leídos con un módulo externo del PLC por la baja resolución que posee. Para esto se planteó utilizar un ESP8266 como interfaz para obtener los pulsos, colocarlos en un registro y enviarlos por un servidor Modbus TCP cada 20ms al PLC. En la sección de programación del PLC se realizó las cuentas correspondientes para realizar la conversión de pulsos a caudal (Figura \ref{fig:modtcp}). Tanto para el módulo, como para el caudalímetro se usó una fuente externa de 3,3 V de alimentación.
\begin{figure}[htbp]
	\centering
	\includegraphics[scale=1]{esp_mod.png}
	\captionof{figure}{Diagrama de flujo del caudalimetro} 
	\label{fig:modtcp}
\end{figure}
\newpage

%\url{
%https://download.schneider-electric.com/files?p_enDocType=User+guide&p_File_Name=35010608_K01_000_11.pdf&p_Doc_Ref=35010608K01000}
